<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MeshChat v8.0</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <style>
        :root { --bg: #36393f; --side: #2f3136; --header: #202225; --accent: #7289da; --text: #dcddde; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg); color: var(--text); overflow: hidden; }
        
        /* Layout */
        .sidebar-left { width: 260px; background: var(--side); display: flex; flex-direction: column; border-right: 1px solid #202225; }
        .main { flex: 1; display: flex; flex-direction: column; position: relative; }
        .sidebar-right { width: 200px; background: var(--side); border-left: 1px solid #202225; padding: 15px; }

        /* UI Elements */
        .header-bar { padding: 15px; background: var(--header); font-weight: bold; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #202225; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; list-style: none; margin: 0; }
        .msg { background: #40444b; padding: 12px; border-radius: 8px; margin-bottom: 10px; max-width: 85%; position: relative; }
        .msg b { color: var(--accent); display: block; font-size: 0.85em; }
        
        .input-area { padding: 20px; background: var(--bg); display: flex; gap: 10px; border-top: 1px solid #202225; }
        input, button { padding: 10px; border-radius: 5px; border: none; background: #40444b; color: white; outline: none; }
        .btn-action { background: var(--accent); cursor: pointer; font-weight: bold; }
        .host-ctrl { color: #ff4747; cursor: pointer; font-size: 10px; margin-left: 8px; border: 1px solid #ff4747; padding: 1px 4px; border-radius: 3px; }

        .member-item { padding: 5px 0; font-size: 0.9em; display: flex; align-items: center; gap: 8px; color: #8e9297; }
        .online-dot { width: 8px; height: 8px; background: #43b581; border-radius: 50%; }

        /* Entry Screen */
        .modal { position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:1000; display:flex; justify-content:center; align-items:center; }
        .modal-content { background: var(--side); padding: 30px; border-radius: 10px; width: 380px; text-align: center; border: 1px solid var(--accent); }
        .modal input { width: 90%; margin-bottom: 15px; text-align: center; }
        .tab-btns { display: flex; gap: 5px; margin-bottom: 15px; justify-content: center; }
        .tab-btns button { flex: 1; font-size: 12px; opacity: 0.6; }
        .tab-btns button.active { opacity: 1; background: var(--accent); }
    </style>
</head>
<body>

<div id="login-screen" class="modal">
    <div class="modal-content">
        <h2>Mesh Login</h2>
        <input type="text" id="user-name" placeholder="Enter Your Name...">
        
        <div class="tab-btns">
            <button id="tab-pub" class="active" onclick="switchTab('pub')">Public Room</button>
            <button id="tab-join" onclick="switchTab('join')">Join ID</button>
            <button id="tab-create" onclick="switchTab('create')">Create New</button>
        </div>

        <div id="ui-create" style="display:none">
            <input type="text" id="new-subj" placeholder="Room Subject (Optional)">
            <button onclick="finalize('create')" class="btn-action" style="width:100%">Create & Launch</button>
        </div>
        <div id="ui-join" style="display:none">
            <input type="text" id="join-id" placeholder="Enter 6-Digit ID">
            <button onclick="finalize('join')" class="btn-action" style="width:100%">Connect to ID</button>
        </div>
        <div id="ui-pub">
            <p style="font-size: 13px; color: #8e9297;">Join the global public mesh.</p>
            <button onclick="finalize('pub')" class="btn-action" style="width:100%">Enter Global Chat</button>
        </div>
    </div>
</div>

<div class="sidebar-left">
    <div class="header-bar">Rooms</div>
    <div style="padding:15px; flex:1;">
        <div style="background:#202225; padding:10px; border-radius:5px;">
            <p id="room-display-id" style="margin:0; font-size:12px; color:var(--accent);"></p>
            <p id="room-display-subj" style="margin:5px 0 0 0; font-weight:bold;"></p>
        </div>
        <br>
        <button onclick="exportLogs()" style="width:100%; margin-bottom:10px;">üíæ Download Logs</button>
        <button onclick="location.reload()" style="width:100%; background:#ed4245;">üö™ Logout</button>
    </div>
</div>

<div class="main">
    <div class="header-bar">
        <span id="header-status">üî¥ Offline</span>
        <button onclick="location.replace('https://google.com')" style="background:#ed4245; font-size:10px;">EXIT NOW</button>
    </div>
    <ul id="messages"></ul>
    <div class="input-area">
        <input type="file" id="upload" style="display:none" onchange="handleFile()">
        <button onclick="document.getElementById('upload').click()">üìÅ</button>
        <input type="text" id="msg-input" placeholder="Type a message..." style="flex:1" onkeydown="if(event.key==='Enter') send()">
        <button class="btn-action" onclick="send()">Send</button>
    </div>
</div>

<div class="sidebar-right">
    <div style="font-size:11px; color:#8e9297; margin-bottom:10px; font-weight:bold;">MEMBERS</div>
    <div id="member-list"></div>
</div>

<script>
    // Multiple relays for better school network bypass
    const gun = Gun([
        'https://gun-manhattan.herokuapp.com/gun',
        'https://peer.wall.org/gun',
        'https://gundb.herokuapp.com/gun'
    ]);

    let myName = "";
    let myRoom = "";
    let isHost = false;
    let ignored = [];

    // --- UI TABS ---
    function switchTab(type) {
        ['pub', 'join', 'create'].forEach(t => {
            document.getElementById('ui-'+t).style.display = (t === type) ? 'block' : 'none';
            document.getElementById('tab-'+t).className = (t === type) ? 'active' : '';
        });
    }

    // --- ENTRY LOGIC ---
    function finalize(type) {
        myName = document.getElementById('user-name').value;
        if(!myName) return alert("Please enter a name first!");

        if(type === 'pub') {
            myRoom = "GLOBAL_PUBLIC_v1";
            launch("Global Public Chat", "PUBLIC");
        } else if(type === 'create') {
            myRoom = Math.floor(100000 + Math.random() * 900000).toString();
            let s = document.getElementById('new-subj').value || "No Subject";
            gun.get('MESH_REGISTRY').get(myRoom).put({id: myRoom, subj: s, host: myName});
            isHost = true;
            launch(s, myRoom);
        } else {
            myRoom = document.getElementById('join-id').value;
            if(!myRoom) return alert("Enter an ID");
            gun.get('MESH_REGISTRY').get(myRoom).once(d => {
                if(d && d.host === myName) isHost = true;
                launch(d ? d.subj : "Private Room", myRoom);
            });
        }
    }

    function launch(subj, id) {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('room-display-id').innerText = "ID: " + id;
        document.getElementById('room-display-subj').innerText = subj;
        document.getElementById('header-status').innerText = "üü¢ Online";
        startChat();
        startPresence();
    }

    // --- CHAT SYSTEM ---
    function send() {
        let val = document.getElementById('msg-input').value;
        if(!val) return;
        gun.get('MESH_CHATS').get(myRoom).get('msgs').set({u: myName, b: val, t: 'txt', time: Date.now()});
        document.getElementById('msg-input').value = "";
    }

    function handleFile() {
        const file = document.getElementById('upload').files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            gun.get('MESH_CHATS').get(myRoom).get('msgs').set({u: myName, b: e.target.result, t: 'img', time: Date.now()});
        };
        reader.readAsDataURL(file);
    }

    function startChat() {
        gun.get('MESH_CHATS').get(myRoom).get('msgs').map().once((data, id) => {
            if(!data || ignored.includes(data.u)) return;
            const li = document.createElement('li');
            li.className = 'msg';
            let body = (data.t === 'img') ? `<img src="${data.b}">` : data.b;
            let ctrls = isHost ? `<span class="host-ctrl" onclick="nuke('${id}')">DEL</span><span class="host-ctrl" onclick="kick('${data.u}')">KICK</span>` : "";
            
            li.innerHTML = `<b>${data.u}</b> ${body} ${ctrls}`;
            document.getElementById('messages').appendChild(li);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        });
    }

    function nuke(id) {
        gun.get('MESH_CHATS').get(myRoom).get('msgs').get(id).put(null);
        location.reload(); 
    }

    function kick(u) {
        if(u === myName) return;
        ignored.push(u);
        alert(u + " has been muted for you.");
    }

    // --- MEMBERS ---
    function startPresence() {
        setInterval(() => {
            gun.get('MESH_CHATS').get(myRoom).get('active').get(myName).put(Date.now());
        }, 4000);

        gun.get('MESH_CHATS').get(myRoom).get('active').map().on((time, name) => {
            const list = document.getElementById('member-list');
            if(Date.now() - time < 10000) {
                if(!document.getElementById('m-'+name)) {
                    let div = document.createElement('div');
                    div.id = 'm-'+name; div.className = 'member-item';
                    div.innerHTML = `<div class="online-dot"></div> ${name}`;
                    list.appendChild(div);
                }
            } else {
                let el = document.getElementById('m-'+name);
                if(el) el.remove();
            }
        });
    }

    function exportLogs() {
        const blob = new Blob([document.getElementById('messages').innerText], {type: 'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `mesh_chat_${myRoom}.txt`;
        a.click();
    }
</script>
</body>
</html>
