<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MeshChat v6.0</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <style>
        :root { --bg: #36393f; --side: #2f3136; --header: #202225; --accent: #7289da; --text: #dcddde; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg); color: var(--text); overflow: hidden; }
        
        /* Layout */
        .sidebar-left { width: 260px; background: var(--side); display: flex; flex-direction: column; border-right: 1px solid #202225; }
        .main { flex: 1; display: flex; flex-direction: column; }
        .sidebar-right { width: 200px; background: var(--side); border-left: 1px solid #202225; padding: 15px; }

        /* UI Components */
        .sidebar-header { padding: 15px; font-weight: bold; background: var(--header); }
        #messages { flex: 1; overflow-y: auto; padding: 20px; list-style: none; margin: 0; }
        .msg { background: #40444b; padding: 12px; border-radius: 8px; margin-bottom: 10px; max-width: 85%; }
        .msg b { color: var(--accent); display: block; font-size: 0.8em; }
        
        .input-area { padding: 20px; background: var(--bg); display: flex; gap: 10px; }
        input, button { padding: 10px; border-radius: 5px; border: none; background: #40444b; color: white; }
        .btn-action { background: var(--accent); cursor: pointer; }

        /* Modals */
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:1000; justify-content:center; align-items:center; display:flex; }
        .modal-content { background: var(--side); padding: 30px; border-radius: 10px; width: 400px; border: 1px solid var(--accent); }
        #admin-modal { display:none; }
        #entry-modal { display:flex; } /* Shows on load */
    </style>
</head>
<body>

<div id="entry-modal" class="modal">
    <div class="modal-content">
        <h2 id="entry-title">Enter MeshChat</h2>
        <input type="text" id="global-username" placeholder="Your Name" style="width:94%; margin-bottom:10px;"><br>
        
        <div id="create-section">
            <input type="text" id="room-subject" placeholder="Subject (Optional)" style="width:94%; margin-bottom:10px;">
            <button onclick="finalizeCreate()" class="btn-action" style="width:100%">Create Room</button>
            <p onclick="toggleEntry(false)" style="font-size:12px; cursor:pointer; text-align:center;">Or Join Existing Room</p>
        </div>

        <div id="join-section" style="display:none;">
            <input type="text" id="room-id-input" placeholder="Room ID (6 Digits)" style="width:94%; margin-bottom:10px;">
            <button onclick="finalizeJoin()" class="btn-action" style="width:100%">Join Room</button>
            <p onclick="toggleEntry(true)" style="font-size:12px; cursor:pointer; text-align:center;">Or Create New Room</p>
        </div>
    </div>
</div>

<div class="sidebar-left">
    <div class="sidebar-header">Rooms & Subjects</div>
    <div id="room-list" style="padding:10px; flex:1;"></div>
    <div style="padding:10px;"><button onclick="location.reload()" style="width:100%">Exit Room</button></div>
</div>

<div class="main">
    <div style="padding:15px; background:var(--header); font-weight:bold;" id="chat-title"># MeshChat</div>
    <ul id="messages"></ul>
    <div class="input-area">
        <input type="file" id="file-input" style="display:none" onchange="sendFile()">
        <button onclick="document.getElementById('file-input').click()">üìÅ</button>
        <input type="text" id="msg-input" placeholder="Type a message..." style="flex:1" onkeydown="if(event.key==='Enter') send()">
        <button class="btn-action" onclick="send()">Send</button>
    </div>
</div>

<div class="sidebar-right">
    <div style="font-size:12px; color:gray; margin-bottom:10px;">ONLINE</div>
    <div id="member-list"></div>
</div>

<div id="admin-modal" class="modal">
    <div class="modal-content" style="max-width:600px; width:80%;">
        <h2>Super Admin Panel</h2>
        <div style="background:#202225; height:200px; overflow-y:auto; padding:10px;" id="admin-registry"></div>
        <hr>
        <h3>Security</h3>
        <input type="password" id="new-admin-pass" placeholder="New Admin Password">
        <button onclick="updateAdminPass()">Update Password</button>
        <button onclick="document.getElementById('admin-modal').style.display='none'">Close</button>
    </div>
</div>

<script>
    const gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);
    let user = "";
    let roomID = "";
    let currentAdminPass = "admin123"; // Initial Default
    let isAdmin = false;

    // Load saved admin pass from Mesh
    gun.get('SYSTEM_CONFIG').get('admin_pass').on(p => { if(p) currentAdminPass = p; });

    // --- ENTRY LOGIC ---
    function toggleEntry(showCreate) {
        document.getElementById('create-section').style.display = showCreate ? 'block' : 'none';
        document.getElementById('join-section').style.display = showCreate ? 'none' : 'block';
    }

    function finalizeCreate() {
        user = document.getElementById('global-username').value;
        let subject = document.getElementById('room-subject').value || "General Chat";
        if(!user) return alert("Enter Name");
        
        roomID = Math.floor(100000 + Math.random() * 900000).toString(); // 6 digit ID
        gun.get('MASTER_REGISTRY_V6').get(roomID).put({id: roomID, subject: subject});
        
        alert("Room Created! ID: " + roomID);
        startChat();
    }

    function finalizeJoin() {
        user = document.getElementById('global-username').value;
        roomID = document.getElementById('room-id-input').value;
        if(!user || !roomID) return alert("Fill all fields");
        startChat();
    }

    function startChat() {
        document.getElementById('entry-modal').style.display = 'none';
        document.getElementById('chat-title').innerText = "# Room: " + roomID;
        listen();
    }

    // --- CHAT LOGIC ---
    function send() {
        let body = document.getElementById('msg-input').value;
        if(!body) return;
        gun.get('CHATS_V6').get(roomID).get('msgs').set({user, body, time: Date.now()});
        document.getElementById('msg-input').value = "";
    }

    function listen() {
        gun.get('CHATS_V6').get(roomID).get('msgs').map().once((data, id) => {
            if(!data) return;
            const li = document.createElement('li');
            li.className = 'msg';
            li.innerHTML = `<b>${data.user}</b> ${data.body}`;
            document.getElementById('messages').appendChild(li);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        });
    }

    // --- ADMIN DASHBOARD ---
    let enters = 0;
    window.addEventListener('keydown', (e) => {
        if(e.key === "Enter") enters++;
        if(e.shiftKey && e.key === "I" && enters >= 2) {
            let p = prompt("Password:");
            if(p === currentAdminPass) {
                isAdmin = true;
                document.getElementById('admin-modal').style.display = 'flex';
                loadRegistry();
            }
            enters = 0;
        }
    });

    function loadRegistry() {
        const reg = document.getElementById('admin-registry');
        reg.innerHTML = "";
        gun.get('MASTER_REGISTRY_V6').map().once((data, id) => {
            if(data) reg.innerHTML += `<div>ID: ${id} | Subject: ${data.subject} <button onclick="joinCreated('${id}')">Enter</button></div>`;
        });
    }

    function joinCreated(id) {
        roomID = id;
        document.getElementById('admin-modal').style.display = 'none';
        startChat();
    }

    function updateAdminPass() {
        let newP = document.getElementById('new-admin-pass').value;
        if(newP.length < 4) return alert("Too short");
        gun.get('SYSTEM_CONFIG').get('admin_pass').put(newP);
        alert("Admin Password Changed Locally and on Mesh.");
    }
</script>
</body>
</html>
