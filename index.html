<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MeshChat v7.0</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <style>
        :root { --bg: #36393f; --side: #2f3136; --header: #202225; --accent: #7289da; --text: #dcddde; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg); color: var(--text); overflow: hidden; }
        
        .sidebar-left { width: 260px; background: var(--side); display: flex; flex-direction: column; border-right: 1px solid #202225; }
        .main { flex: 1; display: flex; flex-direction: column; position: relative; }
        .sidebar-right { width: 200px; background: var(--side); border-left: 1px solid #202225; padding: 15px; }

        .chat-header { padding: 15px; background: var(--header); font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; list-style: none; margin: 0; }
        
        .msg { background: #40444b; padding: 12px; border-radius: 8px; margin-bottom: 10px; max-width: 85%; position: relative; }
        .msg b { color: var(--accent); display: block; font-size: 0.8em; }
        .msg img { max-width: 100%; border-radius: 5px; margin-top: 5px; display: block; }
        
        .input-area { padding: 20px; background: var(--bg); display: flex; gap: 10px; border-top: 1px solid #202225; }
        input, button { padding: 10px; border-radius: 5px; border: none; background: #40444b; color: white; }
        .btn-action { background: var(--accent); cursor: pointer; font-weight: bold; }
        .btn-host { color: #ff4747; cursor: pointer; font-size: 10px; margin-left: 10px; border: 1px solid #ff4747; padding: 2px; }

        .member-item { padding: 5px 0; font-size: 0.9em; display: flex; align-items: center; gap: 8px; }
        .dot { width: 8px; height: 8px; background: #43b581; border-radius: 50%; }

        .modal { position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:1000; display:flex; justify-content:center; align-items:center; }
        .modal-content { background: var(--side); padding: 30px; border-radius: 10px; width: 350px; text-align: center; border: 1px solid var(--accent); }
    </style>
</head>
<body>

<div id="setup-modal" class="modal">
    <div class="modal-content">
        <h2>Mesh Portal</h2>
        <input type="text" id="my-name" placeholder="Your Name" style="width:90%; margin-bottom:10px;">
        <div id="choice-ui">
            <input type="text" id="room-subj" placeholder="Subject (Optional)" style="width:90%; margin-bottom:10px;">
            <button onclick="createRoom()" class="btn-action" style="width:100%">Create New Room</button>
            <p>-- OR --</p>
            <input type="text" id="join-id" placeholder="6-Digit Room ID" style="width:90%; margin-bottom:10px;">
            <button onclick="joinRoom()" class="btn-action" style="width:100%">Join Existing</button>
        </div>
    </div>
</div>

<div class="sidebar-left">
    <div style="padding:15px; background:var(--header); font-weight:bold;">Room Controls</div>
    <div style="padding:15px; flex:1;">
        <p id="display-id" style="color:var(--accent); font-weight:bold;"></p>
        <button onclick="exportLogs()" style="width:100%; margin-bottom:5px;">üíæ Export History</button>
        <button onclick="location.reload()" style="width:100%; background:#ed4245;">üö™ Exit Room</button>
    </div>
</div>

<div class="main">
    <div class="chat-header">
        <span id="topic-display">Connecting...</span>
        <button onclick="location.replace('https://google.com')" style="background:#ed4245; font-size:10px;">PANIC</button>
    </div>
    <ul id="messages"></ul>
    <div class="input-area">
        <input type="file" id="file-up" style="display:none" onchange="handleFile()">
        <button onclick="document.getElementById('file-up').click()">üìÅ</button>
        <input type="text" id="msg-in" placeholder="Type a message..." style="flex:1" onkeydown="if(event.key==='Enter') send()">
        <button class="btn-action" onclick="send()">Send</button>
    </div>
</div>

<div class="sidebar-right">
    <div style="font-size:11px; color:gray; margin-bottom:10px;">MEMBERS</div>
    <div id="member-list"></div>
</div>

<script>
    // FIX: Multiple peers in case one is blocked
    const gun = Gun([
        'https://gun-manhattan.herokuapp.com/gun',
        'https://peer.wall.org/gun',
        'https://gundb.herokuapp.com/gun'
    ]);

    let username = "";
    let activeRoom = "";
    let isHost = false;
    let blacklist = [];

    // --- SETUP ---
    function createRoom() {
        username = document.getElementById('my-name').value;
        if(!username) return alert("Enter Name");
        activeRoom = Math.floor(100000 + Math.random() * 900000).toString();
        let subj = document.getElementById('room-subj').value || "General";
        
        // Register Room and claim Host
        gun.get('REGISTRY_V7').get(activeRoom).put({id: activeRoom, subject: subj, host: username});
        isHost = true;
        init();
    }

    function joinRoom() {
        username = document.getElementById('my-name').value;
        activeRoom = document.getElementById('join-id').value;
        if(!username || !activeRoom) return alert("Fill all fields");
        
        gun.get('REGISTRY_V7').get(activeRoom).once(data => {
            if(data && data.host === username) isHost = true;
            init();
        });
    }

    function init() {
        document.getElementById('setup-modal').style.display = 'none';
        document.getElementById('display-id').innerText = "ID: " + activeRoom;
        
        // Get Subject
        gun.get('REGISTRY_V7').get(activeRoom).get('subject').once(s => {
            document.getElementById('topic-display').innerText = "# " + s;
        });

        startListening();
        startPresence();
    }

    // --- CORE CHAT & HOST TOOLS ---
    function send() {
        let body = document.getElementById('msg-in').value;
        if(!body) return;
        gun.get('CHATS_V7').get(activeRoom).get('msgs').set({user: username, body, type: 'text', time: Date.now()});
        document.getElementById('msg-in').value = "";
    }

    function handleFile() {
        const file = document.getElementById('file-up').files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            gun.get('CHATS_V7').get(activeRoom).get('msgs').set({
                user: username, body: e.target.result, type: 'file', time: Date.now()
            });
        };
        reader.readAsDataURL(file);
    }

    function startListening() {
        gun.get('CHATS_V7').get(activeRoom).get('msgs').map().once((data, id) => {
            if(!data || blacklist.includes(data.user)) return;
            
            const li = document.createElement('li');
            li.className = 'msg';
            let content = data.type === 'file' ? `<img src="${data.body}">` : data.body;
            
            // Host Tools: Delete and Remove
            let tools = isHost ? `<span class="btn-host" onclick="delMsg('${id}')">DEL</span><span class="btn-host" onclick="banUser('${data.user}')">KICK</span>` : "";
            
            li.innerHTML = `<b>${data.user}</b> ${content} ${tools}`;
            document.getElementById('messages').appendChild(li);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        });
    }

    function delMsg(id) {
        gun.get('CHATS_V7').get(activeRoom).get('msgs').get(id).put(null);
        location.reload(); // Refresh to clear deleted view
    }

    function banUser(name) {
        if(name === username) return;
        blacklist.push(name);
        alert(name + " removed from your view.");
    }

    // --- MEMBERS LIST ---
    function startPresence() {
        setInterval(() => {
            gun.get('CHATS_V7').get(activeRoom).get('presence').get(username).put(Date.now());
        }, 3000);

        const list = document.getElementById('member-list');
        gun.get('CHATS_V7').get(activeRoom).get('presence').map().on((time, name) => {
            if(Date.now() - time < 8000) {
                if(!document.getElementById('user-'+name)) {
                    let div = document.createElement('div');
                    div.id = 'user-'+name;
                    div.className = 'member-item';
                    div.innerHTML = `<div class="dot"></div> ${name}`;
                    list.appendChild(div);
                }
            } else {
                let el = document.getElementById('user-'+name);
                if(el) el.remove();
            }
        });
    }

    function exportLogs() {
        const text = document.getElementById('messages').innerText;
        const blob = new Blob([text], {type: 'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `chat_${activeRoom}.txt`;
        a.click();
    }
</script>
</body>
</html>
