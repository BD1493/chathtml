<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Academic Research Portal - v4.2</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root { --bg: #ffffff; --text: #333; --accent: #4A90E2; }
        body { font-family: "Times New Roman", serif; margin: 0; background: var(--bg); color: var(--text); display: flex; flex-direction: column; height: 100vh; transition: 0.3s; }
        
        /* Stealth UI Elements */
        header { padding: 15px 25px; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; cursor: pointer; }
        .logo { font-weight: bold; color: #444; }
        
        #research-feed { flex: 1; overflow-y: auto; padding: 30px; line-height: 1.7; max-width: 900px; margin: 0 auto; width: 100%; }
        .entry { margin-bottom: 20px; border-left: 2px solid #eee; padding-left: 15px; position: relative; }
        .entry b { font-family: Arial, sans-serif; font-size: 11px; color: #888; text-transform: uppercase; }
        
        .input-area { padding: 20px; border-top: 1px solid #eee; display: flex; gap: 10px; background: #fff; justify-content: center; }
        input { border: 1px solid #ddd; padding: 10px; border-radius: 3px; font-family: serif; }
        .btn-save { background: var(--accent); color: white; border: none; padding: 10px 20px; cursor: pointer; font-weight: bold; }

        /* Hidden Hover Menu */
        .stealth-menu { position: fixed; bottom: 10px; right: 10px; opacity: 0; display: flex; gap: 5px; }
        .stealth-menu:hover { opacity: 1; }
        .stealth-menu button { font-size: 10px; padding: 5px; background: #eee; border: 1px solid #ccc; cursor: pointer; }

        /* Fake Wikipedia Mode */
        #wiki-mode { display: none; padding: 40px; overflow-y: auto; background: #fff; position: fixed; inset: 0; z-index: 500; }
        
        /* Modals */
        .modal { display:none; position:fixed; inset:0; background:rgba(255,255,255,0.98); z-index:1000; padding:50px; border: 5px solid var(--accent); }
    </style>
</head>
<body>

<div id="wiki-mode">
    <h1 style="border-bottom: 1px solid #a2a9b1; font-family: serif; font-weight: normal;">Historiography</h1>
    <p>From Wikipedia, the free encyclopedia...</p>
    <p>Historiography is the study of the methods of historians in developing history as an academic discipline, and by extension is any body of historical work on a particular subject. The historiography of a specific topic covers how historians have studied that topic using particular sources, techniques, and theoretical approaches...</p>
    <hr>
    <button onclick="toggleWiki()">Return to Data</button>
</div>

<header onclick="toggleWiki()">
    <div class="logo">Project: Comparative Historiography (v4.2.1)</div>
    <div style="font-size: 12px; color: #999;">Status: Connected to Mesh</div>
</header>

<div id="research-feed">
    <p style="color: #999;"><i>Initializing peer-to-peer data synchronization...</i></p>
</div>

<div class="input-area">
    <input type="text" id="username" placeholder="Initials" style="width: 60px;">
    <input type="text" id="msg-input" placeholder="Enter research note..." style="width: 400px;" onkeydown="if(event.key==='Enter') send()">
    <button class="btn-save" onclick="send()">üíæ Sync Note</button>
</div>

<div class="stealth-menu">
    <button onclick="openPrivate()">üîê Room</button>
    <button onclick="joinPublic()">üåç Global</button>
    <button onclick="location.replace('https://google.com')">Panic</button>
</div>

<div id="admin-dash" class="modal">
    <h2>Network Master Control</h2>
    <div id="room-list" style="border: 1px solid #ddd; height: 300px; overflow: auto; padding: 10px; background: #fdfdfd;"></div>
    <br>
    <button onclick="this.parentElement.style.display='none'">Close Dashboard</button>
</div>

<script>
    // --- CONFIGURATION ---
    const gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);
    let roomID = "Public_Research_Lobby";
    let roomKey = ""; 
    let isAdmin = false;
    let isHost = false;
    const SUPER_ADMIN_PASS = "YOUR_PASSWORD_HERE"; // <--- CHANGE THIS

    // --- STEALTH LOGIC ---
    function toggleWiki() {
        const wiki = document.getElementById('wiki-mode');
        wiki.style.display = (wiki.style.display === 'block') ? 'none' : 'block';
    }

    let enterCount = 0;
    let lastEnter = 0;
    window.addEventListener('keydown', (e) => {
        const now = Date.now();
        if (e.key === "Enter") {
            enterCount = (now - lastEnter < 800) ? enterCount + 1 : 1;
            lastEnter = now;
        }
        if (e.shiftKey && e.key === "I" && enterCount >= 2) {
            let p = prompt("Admin Access Code:");
            if(p === SUPER_ADMIN_PASS) {
                isAdmin = true;
                document.getElementById('admin-dash').style.display='block';
                updateMasterRoomList();
            }
        }
        if (e.key === "Escape") location.replace("https://classroom.google.com");
    });

    // --- ROOM LOGIC ---
    function checkHost(id) {
        gun.get('RESEARCH_DATA_V4').get(id).get('host_meta').once((host) => {
            const current = document.getElementById('username').value || "Anon";
            if (!host) {
                gun.get('RESEARCH_DATA_V4').get(id).get('host_meta').put(current);
                isHost = true;
            } else if (host === current) {
                isHost = true;
            } else {
                isHost = false;
            }
        });
    }

    function openPrivate() {
        let id = prompt("Enter Room ID:");
        let key = prompt("Enter Encryption Key (Private):");
        if(id && key) {
            roomID = id; roomKey = key;
            checkHost(id);
            gun.get('MASTER_REGISTRY').get(id).put(true);
            listen();
        }
    }

    function joinPublic() {
        roomID = "Public_Research_Lobby"; roomKey = ""; isHost = false;
        listen();
    }

    // --- CHAT LOGIC ---
    function send() {
        const user = document.getElementById('username').value || "ANON";
        let body = document.getElementById('msg-input').value;
        if(!body) return;

        if(roomKey) {
            body = "ENC:" + CryptoJS.AES.encrypt(body, roomKey).toString();
        }

        gun.get('RESEARCH_DATA_V4').get(roomID).set({
            user, body, time: Date.now()
        });
        document.getElementById('msg-input').value = "";
    }

    function del(msgId) {
        gun.get('RESEARCH_DATA_V4').get(roomID).get(msgId).put(null);
        alert("Entry removed from mesh.");
        listen();
    }

    function listen() {
        const feed = document.getElementById('research-feed');
        feed.innerHTML = `<p style="color:#aaa">--- Viewing Room: ${roomID} ---</p>`;
        
        gun.get('RESEARCH_DATA_V4').get(roomID).map().once((data, id) => {
            if(!data) return;
            let msg = data.body;

            if(msg.startsWith("ENC:")) {
                if(!roomKey) { msg = "[Encrypted Content]"; }
                else {
                    try {
                        let bytes = CryptoJS.AES.decrypt(msg.replace("ENC:", ""), roomKey);
                        msg = bytes.toString(CryptoJS.enc.Utf8) || "[Decryption Error]";
                    } catch(e) { msg = "[Invalid Key]"; }
                }
            }

            const div = document.createElement('div');
            div.className = 'entry';
            let hostTools = (isHost || isAdmin) ? `<span onclick="del('${id}')" style="color:red;cursor:pointer;font-size:10px;margin-left:10px">[REMOVE]</span>` : "";
            div.innerHTML = `<b>${data.user}</b> ${hostTools}<br>${msg}`;
            feed.appendChild(div);
            feed.scrollTop = feed.scrollHeight;
        });
    }

    function updateMasterRoomList() {
        const list = document.getElementById('room-list');
        list.innerHTML = "";
        gun.get('MASTER_REGISTRY').map().once((val, key) => {
            if(val) list.innerHTML += `<div style="padding:5px; border-bottom:1px solid #eee;">Room: ${key} <button onclick="roomID='${key}'; listen(); document.getElementById('admin-dash').style.display='none';">Join</button></div>`;
        });
    }

    listen();
</script>
</body>
</html>
