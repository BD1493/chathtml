<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mesh Gateway</title>
    <script src="gun.js"></script>
    <script>if(typeof Gun === 'undefined'){ document.write('<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"><\/script>'); }</script>
    
    <style>
        :root { --bg: #36393f; --side: #2f3136; --header: #202225; --accent: #7289da; --text: #dcddde; --danger: #ed4245; }
        body { font-family: 'Helvetica Neue', sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg); color: var(--text); overflow: hidden; }
        .sidebar { width: 260px; background: var(--side); display: flex; flex-direction: column; border-right: 1px solid #202225; }
        .main { flex: 1; display: flex; flex-direction: column; }
        .members-bar { width: 200px; background: var(--side); border-left: 1px solid #202225; padding: 15px; }
        .header { padding: 15px; background: var(--header); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 10; }
        #messages { flex: 1; overflow-y: auto; padding: 25px; list-style: none; margin: 0; }
        .msg { background: #40444b; padding: 12px; border-radius: 8px; margin-bottom: 12px; max-width: 80%; line-height: 1.4; border-left: 4px solid transparent; }
        .msg.admin-msg { border-left-color: gold !important; background: #4e4632 !important; }
        .msg b { color: var(--accent); display: block; font-size: 0.85em; margin-bottom: 4px; }
        .msg img { max-width: 100%; border-radius: 5px; margin-top: 10px; }
        .input-bar { padding: 20px; background: var(--bg); display: flex; gap: 12px; border-top: 1px solid #202225; }
        input, button { padding: 12px; border-radius: 6px; border: none; background: #40444b; color: white; outline: none; }
        .btn-blue { background: var(--accent); cursor: pointer; font-weight: bold; }
        .host-tool { color: var(--danger); cursor: pointer; font-size: 10px; margin-left: 10px; border: 1px solid var(--danger); padding: 2px 5px; border-radius: 4px; }
        .overlay { position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:1000; display:flex; justify-content:center; align-items:center; }
        .login-box { background: var(--side); padding: 40px; border-radius: 12px; width: 400px; text-align: center; }
        .login-box input { width: 100%; margin-bottom: 15px; box-sizing: border-box; }
        .tabs { display: flex; margin-bottom: 20px; border-radius: 6px; overflow: hidden; }
        .tabs button { flex: 1; border-radius: 0; background: #202225; opacity: 0.5; }
        .tabs button.active { opacity: 1; background: var(--accent); }
        #admin-panel { display: none; position: fixed; inset: 20px; background: #18191c; border: 2px solid gold; border-radius: 15px; padding: 30px; z-index: 2000; overflow-y: auto; }
        .status-on { width: 10px; height: 10px; background: #43b581; border-radius: 50%; display: inline-block; margin-right: 8px; }
    </style>
</head>
<body>

<div id="login-modal" class="overlay">
    <div class="login-box">
        <h1 style="margin-top:0">Mesh Login</h1>
        <input type="text" id="entry-name" placeholder="Choose a Username">
        <div class="tabs">
            <button id="t-pub" class="active" onclick="setTab('pub')">Public</button>
            <button id="t-join" onclick="setTab('join')">Join ID</button>
            <button id="t-create" onclick="setTab('create')">Create</button>
        </div>
        <div id="tab-create" style="display:none"><input type="text" id="new-subj" placeholder="Subject..."><button class="btn-blue" style="width:100%" onclick="initMesh('create')">Launch Room</button></div>
        <div id="tab-join" style="display:none"><input type="text" id="join-id" placeholder="6-Digit ID"><button class="btn-blue" style="width:100%" onclick="initMesh('join')">Join Room</button></div>
        <div id="tab-pub"><button class="btn-blue" style="width:100%" onclick="initMesh('pub')">Enter Public Lobby</button></div>
    </div>
</div>

<div class="sidebar">
    <div class="header">Mesh Channels</div>
    <div style="padding: 20px; flex: 1;">
        <div style="background:#202225; padding:15px; border-radius:8px;">
            <div id="room-id-tag" style="font-size:11px; color:var(--accent); font-weight:bold;"></div>
            <div id="room-subj-tag" style="font-size:18px; margin-top:5px;"></div>
        </div>
        <br>
        <button onclick="exportHistory()" style="width:100%; margin-bottom:10px;">üíæ Download History</button>
        <button onclick="logout()" style="width:100%; background:var(--danger);">üö™ Logout</button>
    </div>
</div>

<div class="main">
    <div class="header">
        <span id="net-status">üì° Connecting...</span>
        <button onclick="location.replace('https://classroom.google.com')" style="background:var(--danger); font-size:11px;">PANIC EXIT</button>
    </div>
    <ul id="messages"></ul>
    <div class="input-bar">
        <input type="file" id="file-btn" style="display:none" onchange="uploadFile()">
        <button onclick="document.getElementById('file-btn').click()">üìÅ</button>
        <input type="text" id="chat-in" placeholder="Say something..." style="flex:1" onkeydown="if(event.key==='Enter') sendMsg()">
        <button class="btn-blue" onclick="sendMsg()">Send</button>
    </div>
</div>

<div class="members-bar">
    <div style="font-size:11px; color:#8e9297; margin-bottom:15px; font-weight:bold; letter-spacing:1px;">MEMBERS</div>
    <div id="member-list"></div>
</div>

<div id="admin-panel">
    <h1 style="color:gold">Super Admin Console</h1>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
            <h3>Active Network Registry</h3>
            <div id="admin-rooms" style="background:#202225; padding:15px; border-radius:8px; height:300px; overflow-y:auto;"></div>
        </div>
        <div>
            <h3>Security & Global</h3>
            <input type="text" id="broadcast-msg" placeholder="Global Broadcast Message" style="width:100%; margin-bottom:10px;">
            <button class="btn-blue" onclick="globalBroadcast()">üì£ Send to All Rooms</button>
            <br><br>
            <input type="password" id="new-admin-key" placeholder="New Access Key">
            <button onclick="updateKey()">Update Admin Key</button>
        </div>
    </div>
    <br><br>
    <button onclick="document.getElementById('admin-panel').style.display='none'">Close Dashboard</button>
</div>

<script>
    const gun = Gun(['https://gun-manhattan.herokuapp.com/gun', 'https://peer.wall.org/gun', 'https://gundb.herokuapp.com/gun']);
    
    // PERSISTENCE: Check for saved session
    let myUser = localStorage.getItem('mesh_user') || "";
    let myRoom = localStorage.getItem('mesh_room') || "";
    let mySubj = localStorage.getItem('mesh_subj') || "";
    let isHost = localStorage.getItem('mesh_host') === 'true';
    let adminKey = "admin123";

    window.onload = () => {
        if(myUser && myRoom) launchChat(mySubj, myRoom);
    };

    gun.get('MESH_SYS_V9').get('auth').on(k => { if(k) adminKey = k; });

    function setTab(t) {
        ['pub', 'join', 'create'].forEach(id => {
            document.getElementById('tab-'+id).style.display = (id === t) ? 'block' : 'none';
            document.getElementById('t-'+id).className = (id === t) ? 'active' : '';
        });
    }

    function initMesh(type) {
        myUser = document.getElementById('entry-name').value;
        if(!myUser) return alert("Identify yourself!");
        localStorage.setItem('mesh_user', myUser);

        if(type === 'pub') {
            myRoom = "GLOBAL_v9"; mySubj = "Public Lobby";
            launchChat(mySubj, myRoom);
        } else if(type === 'create') {
            myRoom = Math.floor(100000 + Math.random() * 900000).toString();
            mySubj = document.getElementById('new-subj').value || "No Subject";
            gun.get('MASTER_REGISTRY_V9').get(myRoom).put({id: myRoom, s: mySubj, h: myUser});
            isHost = true;
            localStorage.setItem('mesh_host', 'true');
            launchChat(mySubj, myRoom);
        } else {
            myRoom = document.getElementById('join-id').value;
            gun.get('MASTER_REGISTRY_V9').get(myRoom).once(d => {
                mySubj = d ? d.s : "Room";
                if(d && d.h === myUser) { isHost = true; localStorage.setItem('mesh_host', 'true'); }
                launchChat(mySubj, myRoom);
            });
        }
    }

    function launchChat(s, id) {
        myRoom = id; mySubj = s;
        localStorage.setItem('mesh_room', id);
        localStorage.setItem('mesh_subj', s);
        
        document.getElementById('login-modal').style.display = 'none';
        document.getElementById('room-id-tag').innerText = "ROOM ID: " + id;
        document.getElementById('room-subj-tag').innerText = s;
        document.getElementById('net-status').innerText = "üü¢ CONNECTED";
        startMeshEngine();
    }

    function sendMsg() {
        let val = document.getElementById('chat-in').value;
        if(!val) return;
        gun.get('CHATS_V9').get(myRoom).get('messages').set({u: myUser, b: val, t: 'txt', time: Date.now()});
        document.getElementById('chat-in').value = "";
    }

    function uploadFile() {
        const file = document.getElementById('file-btn').files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            gun.get('CHATS_V9').get(myRoom).get('messages').set({u: myUser, b: e.target.result, t: 'img', time: Date.now()});
        };
        reader.readAsDataURL(file);
    }

    function startMeshEngine() {
        gun.get('CHATS_V9').get(myRoom).get('messages').map().once((data, id) => {
            if(!data) return;
            const li = document.createElement('li');
            li.className = 'msg' + (data.u === 'SYSTEM' ? ' admin-msg' : '');
            let body = (data.t === 'img') ? `<img src="${data.b}">` : data.b;
            let hTools = (isHost) ? `<span class="host-tool" onclick="nuke('${id}')">DELETE</span>` : "";
            
            li.innerHTML = `<b>${data.u}</b> ${body} ${hTools}`;
            document.getElementById('messages').appendChild(li);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        });

        setInterval(() => gun.get('CHATS_V9').get(myRoom).get('users').get(myUser).put(Date.now()), 5000);
        gun.get('CHATS_V9').get(myRoom).get('users').map().on((time, name) => {
            const list = document.getElementById('member-list');
            if(Date.now() - time < 15000) {
                if(!document.getElementById('mem-'+name)) {
                    list.innerHTML += `<div id="mem-${name}" class="member-item"><div class="status-on"></div>${name}</div>`;
                }
            } else {
                let el = document.getElementById('mem-'+name); if(el) el.remove();
            }
        });
    }

    function nuke(id) { gun.get('CHATS_V9').get(myRoom).get('messages').get(id).put(null); location.reload(); }

    function logout() { localStorage.clear(); location.reload(); }

    let enters = 0;
    window.addEventListener('keydown', (e) => {
        if(e.key === "Enter") enters++;
        if(e.shiftKey && e.key === "I" && enters >= 2) {
            if(prompt("Admin Access Code:") === adminKey) {
                document.getElementById('admin-panel').style.display = 'block';
                loadAdminData();
            }
            enters = 0;
        }
    });

    function loadAdminData() {
        const reg = document.getElementById('admin-rooms');
        reg.innerHTML = "";
        gun.get('MASTER_REGISTRY_V9').map().once((d, id) => {
            if(d) reg.innerHTML += `<div style="padding:10px; border-bottom:1px solid #444;">ID: ${id} | Subject: ${d.s} <button onclick="launchChat('${d.s}','${id}')">Join</button></div>`;
        });
    }

    // FIXED GLOBAL BROADCAST
    function globalBroadcast() {
        let msg = document.getElementById('broadcast-msg').value;
        if(!msg) return;
        gun.get('MASTER_REGISTRY_V9').map().once((data, roomID) => {
            if(roomID) gun.get('CHATS_V9').get(roomID).get('messages').set({
                u: 'SYSTEM', b: 'GLOBAL BROADCAST: ' + msg, t: 'txt', time: Date.now()
            });
        });
        // Also send to Public lobby
        gun.get('CHATS_V9').get('GLOBAL_v9').get('messages').set({
            u: 'SYSTEM', b: 'GLOBAL BROADCAST: ' + msg, t: 'txt', time: Date.now()
        });
        alert("Broadcast sent to all registry nodes.");
    }

    function updateKey() {
        let k = document.getElementById('new-admin-key').value;
        if(k) { gun.get('MESH_SYS_V9').get('auth').put(k); alert("Key Updated."); }
    }

    function exportHistory() {
        const b = new Blob([document.getElementById('messages').innerText], {type: 'text/plain'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `mesh_log_${myRoom}.txt`; a.click();
    }
</script>
</body>
</html>
